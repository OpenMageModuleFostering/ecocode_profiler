<?php

class Ecocode_Profiler_Tests_Dev_Model_Collector_MysqlDataCollectorTest
    extends TestHelper
{

    public function testBackTrace()
    {
        $originalTrace = json_decode('[{"file":"\/projects\/ecocode\/ecocode_profiler_test\/magento-1.8.1.0\/vendor\/ecocode\/magento_profiler\/app\/code\/community\/Ecocode\/Profiler\/Model\/Collector\/MysqlDataCollector.php","line":95,"function":"getBackTrace","class":"Ecocode_Profiler_Model_Collector_MysqlDataCollector","object":{},"type":"->","args":[]},{"file":"\/projects\/ecocode\/ecocode_profiler_test\/magento-1.8.1.0\/vendor\/ecocode\/magento_profiler\/app\/code\/community\/Ecocode\/Profiler\/Model\/Collector\/MysqlDataCollector.php","line":40,"function":"getTrace","class":"Ecocode_Profiler_Model_Collector_MysqlDataCollector","object":{},"type":"->","args":[]},{"file":"\/projects\/ecocode\/ecocode_profiler_test\/magento-1.8.1.0\/vendor\/ecocode\/magento_profiler\/app\/code\/community\/Ecocode\/Profiler\/Db\/Statement\/Pdo\/Mysql.php","line":55,"function":"logQuery","class":"Ecocode_Profiler_Model_Collector_MysqlDataCollector","object":{},"type":"->","args":[{}]},{"file":"\/projects\/ecocode\/ecocode_profiler_test\/magento-1.8.1.0\/vendor\/ecocode\/magento_profiler\/app\/code\/community\/Ecocode\/Profiler\/Db\/Statement\/Pdo\/Mysql.php","line":48,"function":"log","class":"Ecocode_Profiler_Db_Statement_Pdo_Mysql","object":{},"type":"->","args":[]},{"file":"\/projects\/ecocode\/ecocode_profiler_test\/magento-1.8.1.0\/httpdocs\/app\/code\/core\/Zend\/Db\/Statement.php","line":291,"function":"_execute","class":"Ecocode_Profiler_Db_Statement_Pdo_Mysql","object":{},"type":"->","args":[{":path0":"",":path1":"\/"}]},{"file":"\/projects\/ecocode\/ecocode_profiler_test\/magento-1.8.1.0\/httpdocs\/lib\/Zend\/Db\/Adapter\/Abstract.php","line":479,"function":"execute","class":"Zend_Db_Statement","object":{},"type":"->","args":[{":path0":"",":path1":"\/"}]},{"file":"\/projects\/ecocode\/ecocode_profiler_test\/magento-1.8.1.0\/httpdocs\/lib\/Zend\/Db\/Adapter\/Pdo\/Abstract.php","line":238,"function":"query","class":"Zend_Db_Adapter_Abstract","object":{},"type":"->","args":["SELECT `core_url_rewrite`.* FROM `core_url_rewrite` WHERE (request_path IN (:path0, :path1)) AND (store_id IN(0, 1))",{":path0":"",":path1":"\/"}]},{"file":"\/projects\/ecocode\/ecocode_profiler_test\/magento-1.8.1.0\/httpdocs\/lib\/Varien\/Db\/Adapter\/Pdo\/Mysql.php","line":428,"function":"query","class":"Zend_Db_Adapter_Pdo_Abstract","object":{},"type":"->","args":["SELECT `core_url_rewrite`.* FROM `core_url_rewrite` WHERE (request_path IN (:path0, :path1)) AND (store_id IN(0, 1))",{":path0":"",":path1":"\/"}]},{"file":"\/projects\/ecocode\/ecocode_profiler_test\/magento-1.8.1.0\/httpdocs\/lib\/Zend\/Db\/Adapter\/Abstract.php","line":734,"function":"query","class":"Varien_Db_Adapter_Pdo_Mysql","object":{},"type":"->","args":[{},{"path0":"","path1":"\/"}]},{"file":"\/projects\/ecocode\/ecocode_profiler_test\/magento-1.8.1.0\/httpdocs\/app\/code\/core\/Mage\/Core\/Model\/Resource\/Url\/Rewrite.php","line":151,"function":"fetchAll","class":"Zend_Db_Adapter_Abstract","object":{},"type":"->","args":[{},{"path0":"","path1":"\/"}]},{"file":"\/projects\/ecocode\/ecocode_profiler_test\/magento-1.8.1.0\/httpdocs\/app\/code\/core\/Mage\/Core\/Model\/Url\/Rewrite.php","line":100,"function":"loadByRequestPath","class":"Mage_Core_Model_Resource_Url_Rewrite","object":{},"type":"->","args":[{},["","\/"]]},{"file":"\/projects\/ecocode\/ecocode_profiler_test\/magento-1.8.1.0\/httpdocs\/app\/code\/core\/Mage\/Core\/Model\/Url\/Rewrite\/Request.php","line":139,"function":"loadByRequestPath","class":"Mage_Core_Model_Url_Rewrite","object":{},"type":"->","args":[["","\/"]]},{"file":"\/projects\/ecocode\/ecocode_profiler_test\/magento-1.8.1.0\/httpdocs\/app\/code\/core\/Mage\/Core\/Model\/Url\/Rewrite\/Request.php","line":116,"function":"_rewriteDb","class":"Mage_Core_Model_Url_Rewrite_Request","object":{},"type":"->","args":[]},{"file":"\/projects\/ecocode\/ecocode_profiler_test\/magento-1.8.1.0\/httpdocs\/app\/code\/core\/Mage\/Core\/Controller\/Varien\/Front.php","line":165,"function":"rewrite","class":"Mage_Core_Model_Url_Rewrite_Request","object":{},"type":"->","args":[]},{"file":"\/projects\/ecocode\/ecocode_profiler_test\/magento-1.8.1.0\/httpdocs\/app\/code\/core\/Mage\/Core\/Model\/App.php","line":354,"function":"dispatch","class":"Mage_Core_Controller_Varien_Front","object":{},"type":"->","args":[]},{"file":"\/projects\/ecocode\/ecocode_profiler_test\/magento-1.8.1.0\/httpdocs\/var\/cache\/Original_Mage_1.0.11-a6f179080788cdb98ede80fce0a470e1.php","line":692,"function":"run","class":"Mage_Core_Model_App","object":{},"type":"->","args":[{"scope_code":"","scope_type":"store","options":{"cache":{"id_prefix":"dev"},"config_model":"Ecocode_Profiler_Model_Core_Config"}}]},{"file":"\/projects\/ecocode\/ecocode_profiler_test\/magento-1.8.1.0\/vendor\/ecocode\/magento_profiler\/dev.php","line":68,"function":"run","class":"MageOriginal","type":"::","args":["","store",{"cache":{"id_prefix":"dev"},"config_model":"Ecocode_Profiler_Model_Core_Config"}]}]', true);
        $expectedTrace = json_decode('[{"file":"\/projects\/ecocode\/ecocode_profiler_test\/magento-1.8.1.0\/httpdocs\/app\/code\/core\/Mage\/Core\/Model\/Url\/Rewrite.php","line":100,"function":"loadByRequestPath","class":"Mage_Core_Model_Resource_Url_Rewrite","object":{},"type":"->","args":[{},["","\/"]]},{"file":"\/projects\/ecocode\/ecocode_profiler_test\/magento-1.8.1.0\/httpdocs\/app\/code\/core\/Mage\/Core\/Model\/Url\/Rewrite\/Request.php","line":139,"function":"loadByRequestPath","class":"Mage_Core_Model_Url_Rewrite","object":{},"type":"->","args":[["","\/"]]},{"file":"\/projects\/ecocode\/ecocode_profiler_test\/magento-1.8.1.0\/httpdocs\/app\/code\/core\/Mage\/Core\/Model\/Url\/Rewrite\/Request.php","line":116,"function":"_rewriteDb","class":"Mage_Core_Model_Url_Rewrite_Request","object":{},"type":"->","args":[]},{"file":"\/projects\/ecocode\/ecocode_profiler_test\/magento-1.8.1.0\/httpdocs\/app\/code\/core\/Mage\/Core\/Controller\/Varien\/Front.php","line":165,"function":"rewrite","class":"Mage_Core_Model_Url_Rewrite_Request","object":{},"type":"->","args":[]},{"file":"\/projects\/ecocode\/ecocode_profiler_test\/magento-1.8.1.0\/httpdocs\/app\/code\/core\/Mage\/Core\/Model\/App.php","line":354,"function":"dispatch","class":"Mage_Core_Controller_Varien_Front","object":{},"type":"->","args":[]},{"file":"\/projects\/ecocode\/ecocode_profiler_test\/magento-1.8.1.0\/httpdocs\/var\/cache\/Original_Mage_1.0.11-a6f179080788cdb98ede80fce0a470e1.php","line":692,"function":"run","class":"Mage_Core_Model_App","object":{},"type":"->","args":[{"scope_code":"","scope_type":"store","options":{"cache":{"id_prefix":"dev"},"config_model":"Ecocode_Profiler_Model_Core_Config"}}]},{"file":"\/projects\/ecocode\/ecocode_profiler_test\/magento-1.8.1.0\/vendor\/ecocode\/magento_profiler\/dev.php","line":68,"function":"run","class":"MageOriginal","type":"::","args":["","store",{"cache":{"id_prefix":"dev"},"config_model":"Ecocode_Profiler_Model_Core_Config"}]}]', true);

        foreach ($originalTrace as &$trace) {
            if (isset($trace['class'])) {
                $trace['object'] = $this->getMockBuilder($trace['class'])->disableOriginalConstructor()->getMock();
            }
        }
        $dataCollector = new Ecocode_Profiler_Model_Collector_MysqlDataCollector();

        $cleanedTrace = $dataCollector->cleanBacktrace($originalTrace);

        $this->assertCount(count($expectedTrace), $cleanedTrace);
    }
}
